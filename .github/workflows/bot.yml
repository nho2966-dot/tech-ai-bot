name: Tech AI Bot Workflow

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 7 * * *'  # ØªØ´ØºÙŠÙ„ ÙŠÙˆÙ…ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 7 ØµØ¨Ø§Ø­Ø§Ù‹
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      MAX_ATTEMPTS: 3
      LOG_DIR: logs
      # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø³ÙŠÙƒØ±ØªØ³ Ø¨Ø§Ù„Ù…Ø³Ù…ÙŠØ§Øª Ø§Ù„Ù„ÙŠ Ø§Ø¹ØªÙ…Ø¯Ù†Ø§Ù‡Ø§
      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run script
        id: run_script
        run: |
          RUN_TS=$(date '+%Y%m%d_%H%M%S')
          echo "RUN_TS=$RUN_TS" >> $GITHUB_ENV
          mkdir -p $LOG_DIR data
          
          if python main.py > "$LOG_DIR/main_$RUN_TS.log" 2>&1; then
            echo "SUCCESS=1" >> $GITHUB_ENV
          else
            echo "SUCCESS=0" >> $GITHUB_ENV
            exit 1
          fi

      - name: Sync Changes
        if: always()
        run: |
          git config --local user.email "bot@nasser-ai.com"
          git config --local user.name "NasserApexBot"
          git add data/*.db logs/*.log || echo "No files"
          git commit -m "ğŸ“ [LOGS]: ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„Ø§Øª Ø£ÙŠØ¨ÙƒØ³ [skip ci]" || echo "No changes"
          git pull --rebase origin main
          git push origin main

      - name: Send Telegram Notification
        if: always()
        run: |
          STATUS=$(if [ "${{ env.SUCCESS }}" == "1" ]; then echo "âœ… Success"; else echo "âŒ Failure"; fi)
          MESSAGE="ğŸ¤– *ØªØ­Ø¯ÙŠØ« Ø¨ÙˆØª Ø§Ù„ØªÙ‚Ù†ÙŠØ© (Nasser AI)*%0A------------------%0AØ§Ù„Ø­Ø§Ù„Ø©: $STATUS%0AØ§Ù„ØªÙˆÙ‚ÙŠØª: ${{ env.RUN_TS }}"
          
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="$MESSAGE"
