name: Tech AI Bot CI/CD Supreme

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 * * * *'  # ŸÉŸÑ ÿ≥ÿßÿπÿ©

jobs:
  # ===============================
  # 1Ô∏è‚É£ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ≥ŸÉÿ±ÿ®ÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä
  # ===============================
  run-script:
    runs-on: ubuntu-latest
    outputs:
      script-log: ${{ steps.run-main.outputs.log-file }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare Logs
        run: mkdir -p logs backup

      - name: Run main.py with Retry
        id: run-main
        run: |
          MAX_ATTEMPTS=3
          ATTEMPT=1
          TIMESTAMP=$(date '+%Y-%m-%d_%H-%M-%S')
          LOG_FILE="logs/main_$TIMESTAMP.log"

          until [ $ATTEMPT -gt $MAX_ATTEMPTS ]; do
            echo "üõ°Ô∏è Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            python main.py >> "$LOG_FILE" 2>&1 && break
            echo "‚ö†Ô∏è Failed, retrying in 5s..."
            ATTEMPT=$((ATTEMPT + 1))
            sleep 5
          done

          if [ $ATTEMPT -gt $MAX_ATTEMPTS ]; then
            echo "‚ùå Script failed after $MAX_ATTEMPTS attempts. Check $LOG_FILE"
            exit 1
          fi

          echo "‚úÖ Script ran successfully. Log: $LOG_FILE"
          echo "::set-output name=log-file::$LOG_FILE"

      - name: Backup DB
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d_%H-%M-%S')
          cp data/*.db backup/db_$TIMESTAMP.db || echo "No DB files to backup"

  # ===============================
  # 2Ô∏è‚É£ ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿØŸÅÿπ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
  # ===============================
  update-db:
    needs: run-script
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --local user.email "bot@nasser-ai.com"
          git config --local user.name "NasserApexBot"

      - name: Commit & Push DB Changes
        run: |
          git add data/*.db backup/*.db || echo "No new DB files to commit"

          if ! git diff --cached --quiet; then
            echo "üõ°Ô∏è DB changes detected, committing..."
            git commit -m "üõ°Ô∏è Apex DB update [skip ci]" || echo "Nothing to commit"
            MAX_RETRIES=5
            RETRY_COUNT=0
            until [ "$RETRY_COUNT" -ge "$MAX_RETRIES" ]; do
              git pull origin main --rebase || echo "‚ö†Ô∏è Pull failed, retrying..."
              git push origin main && break
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "‚ö†Ô∏è Retry push after 5s..."
              sleep 5
            done
          else
            echo "No DB changes to push."

  # ===============================
  # 3Ô∏è‚É£ Notification ÿπÿ®ÿ± Telegram
  # ===============================
  notify:
    needs: [run-script, update-db]
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Notification
        if: always()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="‚úÖ Success"
          if [ ${{ needs.run-script.result }} != "success" ]; then
            STATUS="‚ùå Failed"
          fi
          MESSAGE="üõ°Ô∏è Tech AI Bot Run: $STATUS
          - Log: ${{ needs.run-script.outputs.script-log }}"
          curl -s -X POST https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage \
            -d chat_id=$TELEGRAM_CHAT_ID \
            -d text="$MESSAGE"
