name: Nasser Apex Bot Workflow

on:
  schedule:
    # Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ù…Ø­Ø³ÙˆØ¨Ø© Ø¨ØªÙˆÙ‚ÙŠØª UTC (Ø§Ù„Ø®Ù„ÙŠØ¬ UTC+3)
    - cron: '2 2 * * *'  # 05:00 ØµØ¨Ø§Ø­Ø§Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø®Ù„ÙŠØ¬ - Ø£Ø®Ø¨Ø§Ø± Ø­ØµØ±ÙŠØ©
    - cron: '0 6 * * *'  # 09:00 ØµØ¨Ø§Ø­Ø§Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø®Ù„ÙŠØ¬ - Ø£Ø¯ÙˆØ§Øª ØªÙ‚Ù†ÙŠØ©
    - cron: '0 15 * * *' # 18:00 Ù…Ø³Ø§Ø¡Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø®Ù„ÙŠØ¬ - Ù…Ø³Ø§Ø¨Ù‚Ø§Øª
    - cron: '0 19 * * *' # 22:00 Ù…Ø³Ø§Ø¡Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø®Ù„ÙŠØ¬ - ØªÙØ§Ø¹Ù„ ÙˆØ±Ø¯ÙˆØ¯
  workflow_dispatch: # Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø¨ÙˆØª Ø¨ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ù„Ø³Ø­Ø¨ ÙƒØ§Ù…Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ø¶Ù…Ø§Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ù€ Rebase

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install google-genai openai tweepy requests python-dotenv; fi

      - name: Run Nasser Apex Bot
        env:
          # Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¹Ù‚ÙˆÙ„ ÙˆØ§Ù„Ù…Ù†ØµØ§Øª
          GEMINI_KEY: ${{ secrets.GEMINI_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          
          # Ù…ÙØ§ØªÙŠØ­ Ù…Ù†ØµØ© X
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
        run: python main.py

      - name: Publish to X (Scheduled)
        if: github.event_name == 'schedule'  # ØªÙ†ÙØ° ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
        run: |
          echo "ğŸ›¡ï¸ Ø¨Ø¯Ø¡ Ù†Ø´Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¹Ù„Ù‰ X ÙˆÙÙ‚ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø°Ø±ÙˆØ©"
          python post_to_x.py

      - name: Sync Database Changes
        run: |
          git config --local user.email "bot@nasser-ai.com"
          git config --local user.name "NasserApexBot"

          mkdir -p data
          git add data/*.db || echo "No database found"

          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª
          if ! git diff --cached --quiet; then
            # Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø¤Ù‚ØªÙ‹Ø§ Ù„ØªÙØ§Ø¯ÙŠ Ù…Ø´Ø§ÙƒÙ„ Rebase
            git stash push -m "autosave before rebase"

            # Ø³Ø­Ø¨ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ù…Ù† Main
            git pull origin main --rebase

            # Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
            git stash pop || echo "No stashed changes"

            git commit -m "ğŸ›¡ï¸ ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„Ø§Øª Ø£ÙŠØ¨ÙƒØ³ Ø§Ù„ØªÙ‚Ù†ÙŠØ© [skip ci]"
            git push origin main
          else
            echo "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­ÙØ¸Ù‡Ø§."
          fi
