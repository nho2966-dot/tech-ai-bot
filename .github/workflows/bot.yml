name: Tech AI Bot Workflow

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 7 * * *'  # ØªØ´ØºÙŠÙ„ ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ø§Ù„Ø³Ø§Ø¹Ø© 7 ØµØ¨Ø§Ø­Ù‹Ø§
  workflow_dispatch: # Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ

jobs:
  run-bot:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      MAX_ATTEMPTS: 3
      LOG_DIR: logs
      BACKUP_DIR: backup
      # ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù…Ù† Ø§Ù„Ù€ Secrets Ù„Ù„Ø¨ÙŠØ¦Ø©
      GEMINI_KEY: ${{ secrets.GEMINI_KEY }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      X_API_KEY: ${{ secrets.X_API_KEY }}
      X_API_SECRET: ${{ secrets.X_API_SECRET }}
      X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
      X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
      X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare directories
        run: mkdir -p $LOG_DIR $BACKUP_DIR data

      - name: Run script with retries
        id: run_script
        run: |
          ATTEMPT=1
          SUCCESS=0
          RUN_TS=$(date '+%Y%m%d_%H%M%S')
          echo "RUN_TS=$RUN_TS" >> $GITHUB_ENV
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "ğŸ›¡ï¸ Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            if python main.py > "$LOG_DIR/main_$RUN_TS.log" 2>&1; then
              SUCCESS=1
              break
            fi
            echo "âš ï¸ Attempt $ATTEMPT failed. Waiting 30s..."
            ATTEMPT=$((ATTEMPT+1))
            sleep 30
          done
          
          echo "SUCCESS=$SUCCESS" >> $GITHUB_ENV
          if [ $SUCCESS -ne 1 ]; then exit 1; fi

      - name: Sync Database and Logs
        if: always()
        run: |
          git config --local user.email "bot@nasser-ai.com"
          git config --local user.name "NasserApexBot"
          git add data/*.db logs/*.log || echo "No files"
          git commit -m "ğŸ“ [LOGS]: ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„Ø§Øª Ø£ÙŠØ¨ÙƒØ³ [skip ci]" || echo "No changes"
          # Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø³Ø­Ø¨ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
          git pull --rebase origin main
          git push origin main

      - name: Send Telegram Notification
        if: always()
        run: |
          # ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø³Ù…ÙŠØ§Øª ÙÙŠ Secrets Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ù„Ù…Ø§ ÙŠÙ„ÙŠ:
          STATUS=$(if [ "${{ env.SUCCESS }}" == "1" ]; then echo "âœ… Success"; else echo "âŒ Failure"; fi)
          MESSAGE="ğŸ¤– *Tech AI Bot Update*%0A------------------%0AStatus: $STATUS%0AFile: main_${{ env.RUN_TS }}.log"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="$MESSAGE"
