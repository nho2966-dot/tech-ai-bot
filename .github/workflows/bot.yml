name: Tech AI Bot Workflow

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 7 * * *'  # ุชุดุบูู ูููู 7 ุตุจุงุญุงู ุจุชูููุช ุฌุฑููุชุด
  workflow_dispatch:     # ููุณูุงุญ ุจุงูุชุดุบูู ุงููุฏูู

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Apex Bot
        id: run_script
        env:
          GEMINI_KEY: ${{ secrets.GEMINI_KEY }}
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          # ุฃุถู ุจููุฉ ุงูููุงุชูุญ ููุง (ุชููุชุฑุ ุฅูุฎ)
        run: |
          RUN_TS=$(date '+%Y-%m-%d %H:%M:%S')
          echo "RUN_TS=$RUN_TS" >> $GITHUB_ENV
          mkdir -p logs data
          
          # ุชุดุบูู ุงูุจูุช ูุญูุธ ุงูุญุงูุฉ
          if python main.py; then
            echo "SUCCESS=1" >> $GITHUB_ENV
          else
            echo "SUCCESS=0" >> $GITHUB_ENV
            exit 1
          fi

      - name: Sync Database and Logs
        if: always()
        run: |
          git config --local user.email "bot@nasser-ai.com"
          git config --local user.name "NasserApexBot"
          git add data/*.db logs/*.log || echo "No changes"
          git commit -m "๐ ุชุญุฏูุซ ุขูู ููุณุฌูุงุช [skip ci]" || echo "No changes"
          git push origin main || echo "Push failed"

      - name: Telegram Notification
        if: always()
        run: |
          # ุชุญุฏูุฏ ุฃููููุฉ ุงูุญุงูุฉ
          if [ "${{ env.SUCCESS }}" == "1" ]; then
            STATUS="โ <b>ูุฌุงุญ ุงูุชุดุบูู</b>"
          else
            STATUS="โ <b>ูุดู ุงูุชุดุบูู</b>"
          fi
          
          # ุตูุงุบุฉ ุงูุฑุณุงูุฉ ุจุตูุบุฉ HTML (ุขููุฉ ูู ุฑููุฒ ุงููุธุงู)
          MESSAGE="<b>๐ค ุชูุจูู ุจูุช ุฃูุจูุณ</b>%0A------------------%0A<b>ุงูุญุงูุฉ:</b> $STATUS%0A<b>ุงูุชูููุช:</b> ${{ env.RUN_TS }}%0A------------------%0A<i>ุชููุฏ ุณุฌูุงุช GitHub ููุฒูุฏ ูู ุงูุชูุงุตูู.</i>"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="$MESSAGE"
