name: Tech AI Bot Workflow

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 7 * * *'  # ÿ™ÿ¥ÿ∫ŸäŸÑ ŸäŸàŸÖŸäŸãÿß ÿßŸÑÿ≥ÿßÿπÿ© 7 ÿµÿ®ÿßÿ≠Ÿãÿß

jobs:
  run-bot:
    runs-on: ubuntu-latest

    env:
      MAX_ATTEMPTS: 3
      LOG_DIR: logs
      BACKUP_DIR: backup
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Prepare directories
        run: |
          mkdir -p $LOG_DIR $BACKUP_DIR

      - name: Run script with retries
        id: run_script
        run: |
          ATTEMPT=1
          SUCCESS=0
          TIMESTAMP=$(date '+%Y-%m-%d_%H-%M-%S')
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "üõ°Ô∏è Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            python main.py > "$LOG_DIR/main_$TIMESTAMP.log" 2>&1 && SUCCESS=1 && break
            ATTEMPT=$((ATTEMPT+1))
            sleep 5
          done

          if [ $SUCCESS -eq 1 ]; then
            echo "‚úÖ Script ran successfully. Log: $LOG_DIR/main_$TIMESTAMP.log"
          else
            echo "‚ùå Script failed after $MAX_ATTEMPTS attempts. Check log: $LOG_DIR/main_$TIMESTAMP.log"
            exit 1
          fi

      - name: Backup DB files
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d_%H-%M-%S')
          DB_FOUND=0
          for db_file in data/*.db; do
            if [ -f "$db_file" ]; then
              cp "$db_file" "$BACKUP_DIR/$(basename "$db_file" .db)_$TIMESTAMP.db"
              DB_FOUND=1
              echo "üíæ Backed up: $db_file"
            fi
          done
          if [ $DB_FOUND -eq 0 ]; then
            echo "‚ö†Ô∏è No DB files found to backup"
          fi

      - name: Send Telegram Notification
        if: success() || failure()
        run: |
          STATUS=$(if [ $SUCCESS -eq 1 ]; then echo "‚úÖ Success"; else echo "‚ùå Failure"; fi)
          LOG_FILE="$LOG_DIR/main_$TIMESTAMP.log"
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="Tech AI Bot Run: $STATUS
Log: $LOG_FILE"
