name: Tech AI Bot Workflow

on:
  push:
    branches:
      - main
  schedule:
    # Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù„ÙŠ ÙˆØ¶Ø¹ØªÙ‡ (7 ØµØ¨Ø§Ø­Ø§Ù‹)
    - cron: '0 7 * * *'
  workflow_dispatch: # Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„ÙØ­Øµ)

jobs:
  run-bot:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹ Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Database)

    env:
      MAX_ATTEMPTS: 3
      LOG_DIR: logs
      BACKUP_DIR: backup
      # Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø¨ÙˆØª (ØªØ£ÙƒØ¯ Ø£Ù†Ù‡Ø§ Ø¨Ù†ÙØ³ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙÙŠ Secrets)
      GEMINI_KEY: ${{ secrets.GEMINI_KEY }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      X_API_KEY: ${{ secrets.X_API_KEY }}
      X_API_SECRET: ${{ secrets.X_API_SECRET }}
      X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
      X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
      X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
      # Ù…ÙØ§ØªÙŠØ­ ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare directories
        run: mkdir -p $LOG_DIR $BACKUP_DIR data

      - name: Run script with retries
        id: run_script
        run: |
          ATTEMPT=1
          SUCCESS=0
          # ØªØµØ­ÙŠØ­: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªÙ†Ø§ØºÙ… Ù„Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„Ø§Ø³Ù…
          RUN_TS=$(date '+%Y%m%d_%H%M%S')
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "ğŸ›¡ï¸ Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            python main.py > "$LOG_DIR/main_$RUN_TS.log" 2>&1 && SUCCESS=1 && break
            echo "âš ï¸ Attempt $ATTEMPT failed. Retrying in 30 seconds..."
            ATTEMPT=$((ATTEMPT+1))
            sleep 30 # Ø²Ø¯Ù†Ø§ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ù€ Rate Limit (429)
          done
          
          echo "SUCCESS=$SUCCESS" >> $GITHUB_ENV
          echo "RUN_TS=$RUN_TS" >> $GITHUB_ENV
          if [ $SUCCESS -ne 1 ]; then exit 1; fi

      - name: Sync Database and Logs
        if: always()
        run: |
          git config --local user.email "bot@nasser-ai.com"
          git config --local user.name "NasserApexBot"
          git add data/*.db logs/*.log
          git pull origin main --rebase
          git commit -m "ğŸ“ [LOGS]: ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„Ø§Øª Ø£ÙŠØ¨ÙƒØ³ [skip ci]" || echo "No changes"
          git push origin main

      - name: Send Telegram Notification
        if: always()
        run: |
          STATUS=$(if [ "${{ env.SUCCESS }}" == "1" ]; then echo "âœ… Success"; else echo "âŒ Failure"; fi)
          LOG_INFO="Log: main_${{ env.RUN_TS }}.log"
          MESSAGE="ğŸ¤– *Tech AI Bot Status Update* %0A------------------%0AStatus: $STATUS %0A$LOG_INFO"
          
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="$MESSAGE"
