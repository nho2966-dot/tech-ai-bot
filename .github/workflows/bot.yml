name: Tech AI Bot Workflow

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 7 * * *'  # 10 ØµØ¨Ø§Ø­Ø§Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ÙˆØ§Ù„Ø®Ù„ÙŠØ¬
  workflow_dispatch:      # Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Apex Bot
        id: run_script
        env:
          # --- Ø±Ø¨Ø· Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù…Ù† Ø§Ù„Ù€ Secrets Ø¨Ø§Ù„ÙƒÙˆØ¯ ---
          GEMINI_KEY: ${{ secrets.GEMINI_KEY }}
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          # Ø¥Ø¶Ø§ÙØ© Ù…ÙØ§ØªÙŠØ­ X (Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù†Ø´Ø± ÙÙŠ ØªÙˆÙŠØªØ±)
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        run: |
          RUN_TS=$(date '+%Y-%m-%d %H:%M:%S')
          echo "RUN_TS=$RUN_TS" >> $GITHUB_ENV
          mkdir -p logs data
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ÙˆØ­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
          if python main.py; then
            echo "SUCCESS=1" >> $GITHUB_ENV
          else
            echo "SUCCESS=0" >> $GITHUB_ENV
            exit 1
          fi

      - name: Sync Database and Logs
        if: always()
        run: |
          git config --local user.email "bot@nasser-ai.com"
          git config --local user.name "NasserApexBot"
          git add data/*.db logs/*.log || echo "No changes"
          git commit -m "ğŸ“ ØªØ­Ø¯ÙŠØ« Ø¢Ù„ÙŠ Ù„Ù„Ø³Ø¬Ù„Ø§Øª [skip ci]" || echo "No changes"
          git push origin main || echo "Push failed"

      - name: Telegram Notification
        if: always()
        run: |
          # ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­Ø§Ù„Ø©
          if [ "${{ env.SUCCESS }}" == "1" ]; then
            STATUS="âœ… <b>Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ´ØºÙŠÙ„</b>"
          else
            STATUS="âŒ <b>ÙØ´Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„</b>"
          fi
          
          MESSAGE="<b>ğŸ¤– ØªÙ†Ø¨ÙŠÙ‡ Ù†Ø¸Ø§Ù… Ø£ÙŠØ¨ÙƒØ³</b>%0A------------------%0A<b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> $STATUS%0A<b>Ø§Ù„ØªÙˆÙ‚ÙŠØª:</b> ${{ env.RUN_TS }}%0A------------------%0A<i>ØªÙ… ØªØ­Ø¯ÙŠØ« X ÙˆØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­.</i>"
          
          # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„Ø³ÙƒØ±Øª)
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="$MESSAGE"
