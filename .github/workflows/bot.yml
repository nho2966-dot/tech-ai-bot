name: Nasser Apex Bot Workflow

on:
  schedule:
    # Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ù…Ø­Ø³ÙˆØ¨Ø© Ø¨ØªÙˆÙ‚ÙŠØª UTC (ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø®Ù„ÙŠØ¬ +4)
    - cron: '1 1 * * *'   # 05:00 ØµØ¨Ø§Ø­Ù‹Ø§ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø®Ù„ÙŠØ¬ - Ø£Ø®Ø¨Ø§Ø± Ø­ØµØ±ÙŠØ©
    - cron: '1 9 * * *'   # 13:00 Ø¸Ù‡Ø±Ù‹Ø§ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø®Ù„ÙŠØ¬ - Ø£Ø¯ÙˆØ§Øª ØªÙ‚Ù†ÙŠØ©
    - cron: '1 14 * * *'  # 18:00 Ù…Ø³Ø§Ø¡Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø®Ù„ÙŠØ¬ - Ù…Ø³Ø§Ø¨Ù‚Ø§Øª
    - cron: '1 18 * * *'  # 22:00 Ù…Ø³Ø§Ø¡Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø®Ù„ÙŠØ¬ - ØªÙØ§Ø¹Ù„ ÙˆØ±Ø¯ÙˆØ¯
  workflow_dispatch:       # Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø¨ÙˆØª Ø¨ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install google-genai openai tweepy requests python-dotenv beautifulsoup4 feedparser; fi

      - name: Run Nasser Apex Bot
        env:
          # Ø§Ù„Ø¹Ù‚ÙˆÙ„ Ø§Ù„Ù…ØªÙ†Ø§ÙˆØ¨Ø©
          GEMINI_KEY: ${{ secrets.GEMINI_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          
          # Ù…ÙØ§ØªÙŠØ­ Ù…Ù†ØµØ© X
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
        run: python main.py

      - name: Sync Database Changes Safely
        run: |
          git config --local user.email "bot@nasser-ai.com"
          git config --local user.name "NasserApexBot"

          mkdir -p data
          git add data/*.db

          if ! git diff --cached --quiet; then
            echo "ğŸ›¡ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø¯ÙØ¹..."
            
            MAX_RETRIES=5
            RETRY_COUNT=0
            until git diff --cached --quiet; do
              git pull origin main --rebase
              git commit -m "ğŸ›¡ï¸ ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„Ø§Øª Ø£ÙŠØ¨ÙƒØ³ Ø§Ù„ØªÙ‚Ù†ÙŠØ© [skip ci]" || echo "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…"
              git push origin main && break
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ "$RETRY_COUNT" -ge "$MAX_RETRIES" ]; then
                echo "âš ï¸ ÙØ´Ù„ Ø¯ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ø¹Ø¯ $MAX_RETRIES Ù…Ø­Ø§ÙˆÙ„Ø§Øª"
                exit 1
              fi
              echo "âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¯ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ø§Ù†ØªØ¸Ø§Ø± Ù‚ØµÙŠØ±..."
              sleep 5
            done
            echo "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­."
          else
            echo "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­ÙØ¸Ù‡Ø§."
