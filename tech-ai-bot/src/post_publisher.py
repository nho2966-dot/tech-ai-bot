import os
import tweepy
import random
from google import genai
import logging
import re

logging.basicConfig(level=logging.INFO)

def clean_arabic_text(text):
    """ุชูุธูู ุงููุต ูุถูุงู ุงุญุชุฑุงููุฉ ุงูุญุฑูู ุงูุนุฑุจูุฉ."""
    cleaned = re.sub(r'[^\u0600-\u06FF\s0-9\.\?\!\,\:\-\#\(\)๐ฆ๐ค๐๐กโจ๐ง๐๐ธ๐ฑ๐ปโ]', '', text)
    return " ".join(cleaned.split())

def generate_content_from_gemini():
    """ุชูููุฏ ูุญุชูู ุชููู ุนุงูู ุงููููุฉ (ุชุณุฑูุจุงุชุ ูุคุชูุฑุงุชุ ูุฑุงุฌุนุงุช)."""
    try:
        api_key = os.getenv("GEMINI_KEY")
        client = genai.Client(api_key=api_key)

        # ูุญุงูุฑ ุงููุญุชูู ูุนุงู 2026
        categories = [
            "ุชุณุฑูุจุงุช ุญุตุฑูุฉ ุนู ูุงุชู iPhone 18 Pro ุงููุงุฏู ูููุฒุฉ ุงููุงููุฑุง ุงููุฎููุฉ ุชุญุช ุงูุดุงุดุฉ.",
            "ูุฑุงุฌุนุฉ ุณุฑูุนุฉ ูุฃุญุฏุซ ูุธุงุฑุงุช ุงููุงูุน ุงููุนุฒุฒ (AR) ูู ุณุงูุณููุฌ ุงูุชู ุฃูุทููุช ูู ูุนุฑุถ CES 2026.",
            "ุชุบุทูุฉ ูุคุชูุฑ Apple ูููุทูุฑูู (WWDC26) ููุธุงู ุงูุชุดุบูู ุงูุซูุฑู ุงููุงุฆู ุนูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงููุงูู.",
            "ุงุจุชูุงุฑ ุนุงููู: ุฅุทูุงู ุฃูู ุจุทุงุฑูุฉ ููููุฉ ุตุบูุฑุฉ ููููุงุชู ุชุฏูู ูู 5 ุณููุงุช ุฏูู ุดุญู.",
            "ุชุณุฑูุจุงุช ุนู ูุนุงูุฌ Snapdragon 8 Gen 6 ูููุงุกุฉ ุงูุทุงูุฉ ุงููุฐููุฉ."
        ]
        
        selected_content = random.choice(categories)
        
        prompt = f"""
        ุจุตูุชู ุตุญููุงู ุชูููุงู ูุญุชุฑูุงู ูู ุนุงู 2026ุ ุงูุชุจ ุชุบุฑูุฏุฉ ุฌุฐุงุจุฉ ุฌุฏุงู ุนู: {selected_content}.
        
        ุงููููู ุงููุทููุจ:
        1. ุงูุนููุงู (Emoji + Headline): ุนููุงู ูุซูุฑ ูุดุฏ ุงูุงูุชุจุงู (ูุซูุงู: ๐จ ุชุณุฑูุจ ุญุตุฑูุ ๐ ูุฑุงุฌุนุฉุ ๐ข ุชุบุทูุฉ).
        2. ุงูุชูุงุตูู (The Meat): ูุนูููุฉ ุชูููุฉ ุฏูููุฉ ุฌุฏุงู (ุฃุฑูุงูุ ููุงุตูุงุชุ ุฃู ููุฒุฉ ุซูุฑูุฉ).
        3. ุงูุฑุฃู ุงูุชููู: ุฌููุฉ ูุตูุฑุฉ ุชุนุจุฑ ุนู ูุฌูุฉ ูุธุฑ ุงูุฎุจุฑุงุก ูู ูุฐุง ุงูุงุจุชูุงุฑ.
        4. ุงูุชูุงุนู: ุณุคุงู ูุญูุฒ ุงูุฌูููุฑ ุนูู ุงูููุงุด (ูุซูุงู: ูู ุณุชูุชููู ูุฐุง ุงูุฌูุงุฒุ).
        5. ุงููุตุฏุฑ ูุงููุณูู: "ุงููุตุฏุฑ: X_TechNews_ ุงูุญุตุฑู" ูุชุจูุนุงู ุจูุณูู ูุซู #ุชุณุฑูุจุงุช_ุชูููุฉ #ูุฑุงุฌุนุงุช #ูุณุชูุจู_ุงูุชูููุฉ #AI2026.
        
        ุงููุบุฉ: ูุตุญู ุนุตุฑูุฉุ ุณุฑูุนุฉ ุงูุฅููุงุนุ ูุฌุฐุงุจุฉ (Punchy). ุงุจุชุนุฏ ุนู ุงูุฑุชุงุจุฉ.
        """
        
        response = client.models.generate_content(
            model="gemini-2.0-flash", 
            contents=prompt
        )
        
        if response and response.text:
            return clean_arabic_text(response.text.strip())
        return None
    except Exception as e:
        logging.error(f"โ ุฎุทุฃ ูู ุงูุชูููุฏ: {e}")
        return None

def publish_tech_tweet():
    try:
        content = generate_content_from_gemini()
        if not content:
            content = "๐จ ุชุณุฑูุจ: ูุงุชู iPhone 18 Pro ูุฏ ูุชุฎูู ุชูุงูุงู ุนู ุงูุฃุฒุฑุงุฑ ุงููุงุฏูุฉ! ูู ุฃูุชู ูุณุชุนุฏูู ููุฐุง ุงูุชุบููุฑุ ุงููุตุฏุฑ: ุชุณุฑูุจุงุช 2026. #iPhone18 #ุชูููุฉ"

        client = tweepy.Client(
            consumer_key=os.getenv("X_API_KEY"),
            consumer_secret=os.getenv("X_API_SECRET"),
            access_token=os.getenv("X_ACCESS_TOKEN"),
            access_token_secret=os.getenv("X_ACCESS_SECRET")
        )

        client.create_tweet(text=content[:280])
        logging.info("โ ุชู ูุดุฑ ุงูุชุบุฑูุฏุฉ ุงูุชูููุฉ ุงูุงุญุชุฑุงููุฉ!")
    except Exception as e:
        logging.error(f"โ ุฎุทุฃ ูู ุงููุดุฑ: {e}")

if __name__ == "__main__":
    publish_tech_tweet()
